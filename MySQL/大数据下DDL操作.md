---
flag: green
---
# 大数据量表线上DDL操作方法总结

公司有DBA，不需要我实际操作，写这篇日志权做学习之用吧。

首先，需要知道的是 DDL 操作代价高昂，数据量十几万乃至几十万可能看不到多大的影响，当数据量上升到千万的数据，无论是添加索引还是新加字段，都会造成 DML 操作堵塞，极其影响用户体验。

原因是 DDL 操作会使 MySQL 对表进行加锁（X 锁），导致表只读。加锁是为了保证数据一致性，下面列一下直接DDL操作时，MySQL 做了哪些工作：

> 1、原表添加排它锁；
> 2、生成临时表，该表结构为 DDL 操作后的结构；
> 3、原表中的数据同步到临时表中；
> 4、同步完成，对临时表加排它锁，删除原表；
> 5、临时表重命名，并释放锁。

由此可看，随着数据量增长，DDL 操作越慢，DML 操作堵塞时间越长。

如果去除复制表的过程，速度不就显著上升了吗。确实，在 MySQL 5.5 以后有了一个新的特性，叫做`Fast Index Creation`。描述就是，删除/添加二级索引，不会复制表。当然这种特性仅用于修改索引上，而且修改主键索引，仍会有复制表操作，详情请看 [InnoDB Fast Index Creation](https://dev.mysql.com/doc/refman/5.5/en/innodb-create-index.html)。

`Fast Index Creation` 大大加快了修改索引的速度，但是也只对索引有效，所以，在 MySQL5.6 中对该特性进行了扩充，叫做 `Online DDL`，可以对添加列、删除列、修改列类型、列重命名、设置默认值等 DDL 操作有作用。

根据官网描述，添加/删除索引、设置默认值、修改列等操作不会复制表，添加/删除列、设置列属性NULL
或NOT NULL、添加主键等操作仍会复制表，但是可以在 DDL 时声明`ALGORITHM=INPLACE`提供性能。更为详细的操作情况 [Online DDL Operations](https://dev.mysql.com/doc/refman/5.6/en/innodb-online-ddl-operations.html)。

已上是不做其他任何工具或脚本情况下，利用 MySQL 本身特性进行 DDL 操作。事实上，没有`Online DDL`DBA通常采用下面方法来对大数据表进行DDL操作。

1、临时表+触发器

因为，MySQL 复制表之前为保证数据一致性，会将表进行锁住，导致无法DML操作，从而影响服务正常使用。所以可以手动生成临时表，进行数据复制，不加排它锁，因此不影响服务使用，而其中产生的数据一致性问题可以使用触发器来完成，流程如下：

> 1、生成临时表，该表结构为 DDL 操作后的结构;
> 2、在原表中创建触发器3个触发器分别对应insert,update,delete操作；
> 3、复制数据到临时表（分块复制到临时表）；
> 4、重命名临时表
> 5、删除原表

将上述过程整理为一个可重复使用的工具，那就是 DBA 更为常用的DDL工具了，不同公司可能会使用各自的工具，这里介绍一个工具`pt-online-schema-change`，也是要说的方法二。

2、pt-online-schema-change

这是 percona 公司推出的一个针对 MySQL 在线 DDL 的一个工具，大体工作流程和方法一差不多，[# pt-online-schema-change使用说明、限制与比较](http://seanlook.com/2016/05/27/mysql-pt-online-schema-change/) 有更为详细的介绍，我也是看这篇文章知道这个工具的。

3、主从库滚动式更新

这也是一部分公司使用的方法。停止某一台主服务器，进行更新，其他主服务器提供支持，在对从服务器更新，依次进行，直到所有服务器更新完毕。这种滚动更新的弊端就是慢，且只能在低流量访问的时候进行，不能影响到用户访问。

我第一份工作所在的公司就是使用这种方法，记得刚刚去公司报道，技术部只有前端在，后端人员加了一夜班，为了滚动更新时服务出现问题第一时间可以修复。

以上就是我了解的线上DDL操作的方法，事实上我从未从事过DBA相关工作，纸上谈兵罢了。